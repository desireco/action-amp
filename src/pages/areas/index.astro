---
import AppLayout from "../../layouts/AppLayout.astro";
import { getCollection } from "astro:content";
import { LayoutGrid, Folder, ChevronRight, Plus } from "lucide-astro";
import { getSettings } from "../../lib/data/settings";

const areas = await getCollection("areas");
const projects = await getCollection("projects");
const settings = await getSettings();
const currentContext = settings.next_action_context;

// Group projects by area
const projectsByArea = projects.reduce(
    (acc, project) => {
        const areaName = project.data.area;
        if (!acc[areaName]) {
            acc[areaName] = [];
        }
        acc[areaName].push(project);
        return acc;
    },
    {} as Record<string, typeof projects>,
);

const priorityOrder: Record<string, number> = { high: 0, medium: 1, low: 2 };
const sortedAreas = areas.sort((a, b) => {
    const pA = priorityOrder[a.data.priority] ?? 1;
    const pB = priorityOrder[b.data.priority] ?? 1;
    return pA - pB;
});
---

<AppLayout title="Areas | Action Amp">
    <div class="mb-4 md:mb-8">
        <div class="flex items-center justify-between mb-2">
            <h1
                class="text-3xl font-bold text-text-main flex items-center gap-3"
            >
                <LayoutGrid class="h-8 w-8 text-primary" />
                Areas of Focus
            </h1>
            <a
                href="/areas/new"
                class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-hover transition-colors shadow-sm hover:shadow-md"
            >
                <Plus class="h-5 w-5" />
                <span class="hidden sm:inline">Create Area</span>
            </a>
        </div>
        <p class="text-text-muted mt-1">
            High-level responsibilities and long-term goals.
        </p>
    </div>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {
            sortedAreas.map((area) => {
                const areaSlug = area.id.split("/")[0];
                const areaProjects = projectsByArea[areaSlug] || [];
                const isContext = currentContext === areaSlug;

                return (
                    <div
                        class:list={[
                            "bg-surface border rounded-xl overflow-hidden flex flex-col h-full transition-all shadow-sm hover:shadow-md",
                            isContext
                                ? "border-primary ring-1 ring-primary"
                                : "border-border hover:border-primary/50",
                        ]}
                    >
                        <div class="p-6 border-b border-border bg-surface-hover/30">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-xl font-bold text-text-main flex items-center gap-2">
                                    {area.data.name}
                                    {isContext && (
                                        <span class="px-2 py-0.5 rounded-full bg-primary text-white text-[10px] font-bold uppercase tracking-wider">
                                            Focus
                                        </span>
                                    )}
                                </h2>
                                <span
                                    class:list={[
                                        "px-2 py-0.5 rounded text-xs font-medium uppercase tracking-wider",
                                        area.data.priority === "high"
                                            ? "bg-red-500/10 text-red-500"
                                            : "bg-surface-hover text-text-muted",
                                    ]}
                                >
                                    {area.data.priority}
                                </span>
                            </div>
                            {area.data.description && (
                                <p class="text-sm text-text-muted line-clamp-2">
                                    {area.data.description}
                                </p>
                            )}
                        </div>

                        <div class="p-4 flex-1 bg-surface">
                            <h3 class="text-xs font-semibold text-text-muted uppercase tracking-wider mb-3 flex items-center gap-2">
                                <Folder class="h-3 w-3" />
                                Active Projects
                            </h3>
                            <div class="space-y-1">
                                {areaProjects.length > 0 ? (
                                    areaProjects.map((project) => (
                                        <a
                                            href={`/projects/${project.id}`}
                                            class="flex items-center justify-between p-2 rounded-lg hover:bg-surface-hover group transition-colors"
                                        >
                                            <div class="flex items-center gap-2 min-w-0">
                                                <div class="w-1.5 h-1.5 rounded-full bg-primary flex-shrink-0" />
                                                <span class="text-sm text-text-main truncate">
                                                    {project.data.name}
                                                </span>
                                            </div>
                                            <ChevronRight class="h-4 w-4 text-text-muted opacity-0 group-hover:opacity-100 transition-opacity" />
                                        </a>
                                    ))
                                ) : (
                                    <p class="text-sm text-text-muted italic pl-2">
                                        No active projects
                                    </p>
                                )}
                            </div>
                        </div>

                        <div class="p-3 border-t border-border bg-surface-hover/10 flex items-center justify-between gap-2">
                            {!isContext && (
                                <button
                                    class="flex-1 text-sm font-medium py-1.5 px-3 rounded-lg transition-colors text-center bg-primary/10 text-primary hover:bg-primary/20"
                                    data-set-context={areaSlug}
                                >
                                    Set Context
                                </button>
                            )}
                            <a
                                href={`/areas/${areaSlug}`}
                                class:list={[
                                    "text-sm font-medium text-text-muted hover:text-text-main transition-colors px-3 py-1.5",
                                    isContext ? "w-full text-center" : "",
                                ]}
                            >
                                Details
                            </a>
                        </div>
                    </div>
                );
            })
        }
    </div>
</AppLayout>

<script>
    const buttons = document.querySelectorAll("button[data-set-context]");

    // Simple spinner SVG
    const spinner = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-current inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>`;

    buttons.forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const button = btn as HTMLButtonElement;
            const originalContent = button.innerHTML;
            const context = button.getAttribute("data-set-context");

            // Set loading state
            button.disabled = true;
            button.innerHTML = `${spinner} Refocusing...`;

            // Disable other buttons too
            buttons.forEach((b) => ((b as HTMLButtonElement).disabled = true));

            try {
                const res = await fetch("/api/settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ next_action_context: context }),
                });

                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to update context");
                    // Reset state
                    button.innerHTML = originalContent;
                    buttons.forEach(
                        (b) => ((b as HTMLButtonElement).disabled = false),
                    );
                }
            } catch (err) {
                console.error(err);
                alert("Error updating context");
                // Reset state
                button.innerHTML = originalContent;
                buttons.forEach(
                    (b) => ((b as HTMLButtonElement).disabled = false),
                );
            }
        });
    });
</script>
