---
import AppLayout from "../../layouts/AppLayout.astro";
import { getCollection } from "astro:content";
import { LayoutGrid, Folder, ChevronRight, Plus } from "lucide-astro";

const areas = await getCollection("areas");
const projects = await getCollection("projects");

// Group projects by area
// Note: project.data.area should match area.data.name or area.id?
// The schema says area: z.string(). It likely refers to the area name or directory name.
// Let's assume it matches area.id or area.data.name.
// Based on file structure: data/areas/work/area.toml -> id: work/area.toml
// data/areas/work/website-redesign/project.toml -> area: "work" (likely)
// Let's check the data to be sure, but for now I'll try to match loosely.

const projectsByArea = projects.reduce(
    (acc, project) => {
        const areaName = project.data.area;
        // Normalize if needed, but assuming exact match for now
        if (!acc[areaName]) {
            acc[areaName] = [];
        }
        acc[areaName].push(project);
        return acc;
    },
    {} as Record<string, typeof projects>,
);

const priorityOrder: Record<string, number> = { high: 0, medium: 1, low: 2 };
const sortedAreas = areas.sort((a, b) => {
    const pA = priorityOrder[a.data.priority] ?? 1;
    const pB = priorityOrder[b.data.priority] ?? 1;
    return pA - pB;
});
---

<AppLayout title="Areas | Action Amp">
    <div class="mb-4 md:mb-8">
        <div class="flex items-center justify-between mb-2">
            <h1
                class="text-3xl font-bold text-text-main flex items-center gap-3"
            >
                <LayoutGrid class="h-8 w-8 text-primary" />
                Areas of Focus
            </h1>
            <a
                href="/areas/new"
                class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-hover transition-colors shadow-sm hover:shadow-md"
            >
                <Plus class="h-5 w-5" />
                <span class="hidden sm:inline">Create Area</span>
            </a>
        </div>
        <p class="text-text-muted mt-1">
            High-level responsibilities and long-term goals.
        </p>
    </div>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {
            sortedAreas.map((area) => {
                // We need to match area.id (e.g. "work/area.toml") to project.data.area (e.g. "work")
                // So we extract the directory name from area.id
                const areaSlug = area.id.split("/")[0];
                const areaProjects = projectsByArea[areaSlug] || [];

                return (
                    <div class="bg-surface border border-border rounded-xl overflow-hidden flex flex-col h-full hover:border-primary/50 transition-colors shadow-sm hover:shadow-md">
                        <div class="p-6 border-b border-border bg-surface-hover/30">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-xl font-bold text-text-main">
                                    {area.data.name}
                                </h2>
                                <span
                                    class:list={[
                                        "px-2 py-0.5 rounded text-xs font-medium uppercase tracking-wider",
                                        area.data.priority === "high"
                                            ? "bg-red-500/10 text-red-500"
                                            : "bg-surface-hover text-text-muted",
                                    ]}
                                >
                                    {area.data.priority}
                                </span>
                            </div>
                            {area.data.description && (
                                <p class="text-sm text-text-muted line-clamp-2">
                                    {area.data.description}
                                </p>
                            )}
                        </div>

                        <div class="p-4 flex-1 bg-surface">
                            <h3 class="text-xs font-semibold text-text-muted uppercase tracking-wider mb-3 flex items-center gap-2">
                                <Folder class="h-3 w-3" />
                                Active Projects
                            </h3>
                            <div class="space-y-1">
                                {areaProjects.length > 0 ? (
                                    areaProjects.map((project) => (
                                        <a
                                            href={`/projects/${project.id}`}
                                            class="flex items-center justify-between p-2 rounded-lg hover:bg-surface-hover group transition-colors"
                                        >
                                            <div class="flex items-center gap-2 min-w-0">
                                                <div class="w-1.5 h-1.5 rounded-full bg-primary flex-shrink-0" />
                                                <span class="text-sm text-text-main truncate">
                                                    {project.data.name}
                                                </span>
                                            </div>
                                            <ChevronRight class="h-4 w-4 text-text-muted opacity-0 group-hover:opacity-100 transition-opacity" />
                                        </a>
                                    ))
                                ) : (
                                    <p class="text-sm text-text-muted italic pl-2">
                                        No active projects
                                    </p>
                                )}
                            </div>
                        </div>

                        <div class="p-3 border-t border-border bg-surface-hover/10 text-center">
                            <a
                                href={`/areas/${areaSlug}`}
                                class="text-sm font-medium text-primary hover:text-primary-hover transition-colors inline-flex items-center"
                            >
                                View Area Details
                                <ChevronRight class="h-3 w-3 ml-1" />
                            </a>
                        </div>
                    </div>
                );
            })
        }
    </div>
</AppLayout>
