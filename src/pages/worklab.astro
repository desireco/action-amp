---
import AppLayout from "../layouts/AppLayout.astro";
import { dataReader } from "../lib/data/reader";
import { fsApi } from "../lib/data/api";
import path from "node:path";
import CheckCircle2 from "~icons/lucide/check-circle-2";
import AlertCircle from "~icons/lucide/alert-circle";
import Clock from "~icons/lucide/clock";
import ArrowRight from "~icons/lucide/arrow-right";
import Heading from "../components/ui/Heading.astro";
import Card from "../components/ui/Card.astro";
import Button from "../components/ui/Button.astro";
import TaskEditor from "../components/WorkLab/TaskEditor.astro";
import StatusControls from "../components/WorkLab/StatusControls.astro";
import TaskUpdates from "../components/WorkLab/TaskUpdates.astro";

const { currentUser } = Astro.locals as any;
const settings = (Astro.locals as any).settings;
const currentContext = settings.next_action_context;

const allActions = await dataReader.getAllActions(currentUser);
const allProjects = await dataReader.getAllProjects(currentUser);

// Filter for current task - For now, we'll show the first in-progress task in the current context
const getCurrentTask = () => {
    // First, look for tasks in progress
    const inProgressTasks = allActions.filter((action) => {
        if (currentContext && action.data.area !== currentContext) return false;
        return action.data.status === "in_progress";
    });

    if (inProgressTasks.length > 0) {
        return inProgressTasks[0];
    }

    // If no in-progress tasks, get the highest priority todo
    const todoTasks = allActions.filter((action) => {
        if (currentContext && action.data.area !== currentContext) return false;
        return action.data.status === "todo";
    });

    if (todoTasks.length > 0) {
        // Sort by priority
        const priorityOrder: Record<string, number> = {
            high: 0,
            medium: 1,
            low: 2,
        };
        todoTasks.sort((a, b) => {
            const pA = priorityOrder[a.data.priority] ?? 1;
            const pB = priorityOrder[b.data.priority] ?? 1;
            if (pA !== pB) return pA - pB;

            const timeA = new Date(a.data.created).getTime();
            const timeB = new Date(b.data.created).getTime();
            return timeA - timeB;
        });
        return todoTasks[0];
    }

    return null;
};

const currentTask = getCurrentTask();

// Get project name for display
const getProjectName = (area: string, project: string) => {
    const projectData = allProjects.find((p) =>
        p.id.startsWith(`${area}/${project}`),
    );
    return projectData?.data.name || project;
};

// Load existing updates for the current task
async function getTaskUpdates(taskId: string) {
    if (!taskId) return [];

    try {
        // Extract area, project, and filename from taskId
        const [area, project, filename] = taskId.split("/");
        const updatesFilePathPrefix = path.join(
            "areas",
            area,
            project,
            `${filename}.updates.json`,
        );

        // Check if updates file exists
        try {
            const updatesContent = await fsApi.readFile(
                updatesFilePathPrefix,
                currentUser,
            );
            const updates = JSON.parse(updatesContent);
            // Convert timestamp strings back to Date objects
            return updates.map((update: any) => ({
                ...update,
                timestamp: new Date(update.timestamp),
            }));
        } catch (error) {
            // File doesn't exist yet, return empty array
            return [];
        }
    } catch (error) {
        console.error("Error loading task updates:", error);
        return [];
    }
}

const taskUpdates = currentTask ? await getTaskUpdates(currentTask.id) : [];
---

<AppLayout title="WorkLab">
    <div class="space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <Heading level={1} class="text-3xl font-bold text-text-main"
                    >WorkLab</Heading
                >
                <p class="text-text-muted mt-2">
                    {
                        currentContext
                            ? `Focused workspace for ${currentContext} context.`
                            : "Your focused workspace for the current task."
                    }
                </p>
            </div>
            {
                currentContext && (
                    <Button href="/areas" variant="outline" size="sm">
                        Switch Context
                    </Button>
                )
            }
        </div>

        {
            !currentTask ? (
                <Card class="text-center py-12 bg-surface border border-border border-dashed">
                    <CheckCircle2 class="w-12 h-12 text-text-muted mx-auto mb-4" />
                    <Heading
                        level={3}
                        class="text-lg font-medium text-text-main"
                    >
                        No Current Task
                    </Heading>
                    <p class="text-text-muted mb-6">
                        {currentContext
                            ? `No active tasks in the ${currentContext} context.`
                            : "Select a task to work on from your Next Actions."}
                    </p>
                    <Button href="/next">View Next Actions</Button>
                </Card>
            ) : (
                <div class="space-y-6">
                    {/* Current Task Card */}
                    <Card class="p-6 bg-surface border border-border">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <Heading
                                        level={2}
                                        class="text-2xl font-bold text-text-main"
                                    >
                                        {currentTask.data.title}
                                    </Heading>
                                    {currentTask.data.priority === "high" && (
                                        <AlertCircle class="w-5 h-5 text-red-500" />
                                    )}
                                </div>

                                <div class="flex items-center gap-4 text-sm text-text-muted mb-4">
                                    <a
                                        href={`/projects/${currentTask.data.area}/${currentTask.data.project}`}
                                        class="flex items-center hover:text-primary transition-colors"
                                    >
                                        <span class="font-medium">
                                            {getProjectName(
                                                currentTask.data.area,
                                                currentTask.data.project,
                                            )}
                                        </span>
                                        <ArrowRight class="w-3 h-3 mx-1" />
                                        <span class="capitalize">
                                            {currentTask.data.area}
                                        </span>
                                    </a>
                                    {currentTask.data.created && (
                                        <span
                                            class="flex items-center"
                                            title={`Created: ${new Date(currentTask.data.created).toLocaleDateString()}`}
                                        >
                                            <Clock class="w-3 h-3 mr-1" />
                                            {Math.floor(
                                                (new Date().getTime() -
                                                    new Date(
                                                        currentTask.data.created,
                                                    ).getTime()) /
                                                    (1000 * 60 * 60 * 24),
                                            )}
                                            d ago
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Task Editor */}
                        <div class="mb-6">
                            <TaskEditor
                                taskId={currentTask.id}
                                initialTitle={currentTask.data.title}
                                initialContent={
                                    currentTask.data.content
                                        .split("\n")
                                        .slice(1)
                                        .join("\n") || ""
                                }
                                onSave={async (taskId, title, content) => {
                                    // Save to filesystem
                                    const response = await fetch(
                                        "/api/actions/edit",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                path: taskId.replace(".md", ""),
                                                title: title,
                                                content: content,
                                            }),
                                        },
                                    );
                                    if (!response.ok) {
                                        throw new Error("Failed to save task");
                                    }
                                    // Reload page to show changes
                                    window.location.reload();
                                }}
                            />
                        </div>

                        {/* Status Controls */}
                        <div class="mt-4">
                            <StatusControls
                                taskId={currentTask.id}
                                currentStatus={currentTask.data.status as any}
                                onStatusChange={async (taskId, newStatus) => {
                                    const response = await fetch(
                                        "/api/actions/status",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                path: `areas/${taskId}`,
                                                status: newStatus,
                                            }),
                                        },
                                    );
                                    if (!response.ok) {
                                        throw new Error(
                                            "Failed to update status",
                                        );
                                    }
                                    // Reload page to show changes
                                    window.location.reload();
                                }}
                            />
                        </div>
                    </Card>

                    {/* Task Updates Section */}
                    <Card class="p-6 bg-surface border border-border">
                        <TaskUpdates
                            taskId={currentTask.id}
                            updates={taskUpdates}
                            onPostUpdate={async (taskId, content) => {
                                // Save the update to a .updates.json file
                                try {
                                    const response = await fetch(
                                        "/api/actions/updates",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                taskId: taskId,
                                                content: content,
                                            }),
                                        },
                                    );

                                    if (!response.ok) {
                                        throw new Error(
                                            "Failed to save update",
                                        );
                                    }

                                    // Reload page to show the new update
                                    window.location.reload();
                                } catch (error) {
                                    console.error(
                                        "Error posting update:",
                                        error,
                                    );
                                    alert(
                                        "Failed to post update. Please try again.",
                                    );
                                }
                            }}
                        />
                    </Card>
                </div>
            )
        }
    </div>
</AppLayout>
