---
import AppLayout from "../layouts/AppLayout.astro";
import { getCollection } from "astro:content";
import { getSettings } from "../lib/data/settings";
import { Check, LayoutGrid, X } from "lucide-astro";

const areas = await getCollection("areas");
const settings = await getSettings();
const currentContext = settings.next_action_context;

const sortedAreas = areas.sort((a, b) =>
    a.data.name.localeCompare(b.data.name),
);
---

<AppLayout title="Context Selection">
    <div class="space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-text-main">
                    Context Selection
                </h1>
                <p class="text-text-muted mt-2">
                    Select a context (Area) to focus your Next Actions and
                    Projects.
                </p>
            </div>
            {
                currentContext && (
                    <button
                        id="clear-context"
                        class="flex items-center px-4 py-2 text-sm font-medium text-red-500 bg-red-500/10 rounded-lg hover:bg-red-500/20 transition-colors"
                    >
                        <X class="w-4 h-4 mr-2" />
                        Clear Context
                    </button>
                )
            }
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {
                sortedAreas.map((area) => {
                    const isSelected = currentContext === area.id; // area.id is the slug/folder name usually
                    return (
                        <button
                            class:list={[
                                "context-card relative flex flex-col p-6 rounded-xl border-2 text-left transition-all duration-200 group",
                                isSelected
                                    ? "border-primary bg-primary/5 shadow-lg shadow-primary/10"
                                    : "border-border bg-surface hover:border-primary/50 hover:shadow-md",
                            ]}
                            data-context={area.id}
                        >
                            <div class="flex items-start justify-between w-full mb-4">
                                <div
                                    class:list={[
                                        "p-3 rounded-lg",
                                        isSelected
                                            ? "bg-primary text-white"
                                            : "bg-surface-hover text-text-muted group-hover:text-primary",
                                    ]}
                                >
                                    <LayoutGrid class="w-6 h-6" />
                                </div>
                                {isSelected && (
                                    <div class="bg-primary text-white p-1 rounded-full">
                                        <Check class="w-4 h-4" />
                                    </div>
                                )}
                            </div>

                            <h3
                                class:list={[
                                    "text-lg font-semibold mb-2",
                                    isSelected
                                        ? "text-primary"
                                        : "text-text-main",
                                ]}
                            >
                                {area.data.name}
                            </h3>

                            {area.data.description && (
                                <p class="text-sm text-text-muted line-clamp-2">
                                    {area.data.description}
                                </p>
                            )}
                        </button>
                    );
                })
            }
        </div>
    </div>
</AppLayout>

<script>
    const cards = document.querySelectorAll(".context-card");
    const clearBtn = document.getElementById("clear-context");

    async function setContext(context: string | null) {
        try {
            const res = await fetch("/api/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ next_action_context: context || "" }), // Empty string to clear
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert("Failed to update context");
            }
        } catch (err) {
            console.error(err);
            alert("Error updating context");
        }
    }

    cards.forEach((card) => {
        card.addEventListener("click", () => {
            const context = card.getAttribute("data-context");
            if (context) {
                setContext(context);
            }
        });
    });

    clearBtn?.addEventListener("click", () => {
        setContext(null);
    });
</script>
