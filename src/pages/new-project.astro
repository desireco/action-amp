---
import AppLayout from "../layouts/AppLayout.astro";
import { getCollection } from "astro:content";
import Heading from "../components/ui/Heading.astro";
import Card from "../components/ui/Card.astro";
import Button from "../components/ui/Button.astro";
import Input from "../components/ui/Input.astro";

const areas = await getCollection("areas");
---

<AppLayout title="New Project | Action Amp">
    <div class="max-w-2xl mx-auto">
        <Heading level={1} class="mb-8"> Create New Project </Heading>

        <Card class="p-6">
            <form id="create-project-form" class="space-y-6">
                <div>
                    <label
                        for="name"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Project Name</label
                    >
                    <Input
                        type="text"
                        id="name"
                        name="name"
                        required
                        placeholder="e.g., Q4 Marketing Campaign"
                    />
                </div>

                <div>
                    <label
                        for="area"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Area</label
                    >
                    <select
                        id="area"
                        name="area"
                        required
                        class="flex h-10 w-full rounded-lg border border-border bg-surface px-3 py-2 text-sm text-text-main ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-text-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option value="" disabled selected
                            >Select an Area</option
                        >
                        {
                            areas.map((area) => {
                                const areaSlug = area.id.split("/")[0];
                                return (
                                    <option value={areaSlug}>
                                        {area.data.name}
                                    </option>
                                );
                            })
                        }
                    </select>
                </div>

                <div>
                    <label
                        for="description"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Description</label
                    >
                    <textarea
                        id="description"
                        name="description"
                        rows="4"
                        class="w-full bg-background border border-border rounded-lg px-4 py-3 text-text-main placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all resize-none"
                        placeholder="What is this project about?"></textarea>
                </div>

                <div class="flex justify-end gap-4">
                    <Button href="/areas" variant="ghost"> Cancel </Button>
                    <Button type="submit"> Create Project </Button>
                </div>
            </form>
        </Card>
    </div>

    <script>
        const form = document.getElementById("create-project-form");
        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target as HTMLFormElement);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch("/api/projects", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const result = await response.json();
                    // Redirect to the new project page
                    // The result contains { path, slug }
                    // The URL structure is /projects/[area]/[project-slug]/project.toml
                    window.location.href = `/projects/${data.area}/${result.slug}/project.toml`;
                } else {
                    alert("Failed to create project");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred");
            }
        });
    </script>
</AppLayout>
