---
import AppLayout from "../../layouts/AppLayout.astro";
import { getEntry, getCollection } from "astro:content";
import ArrowLeft from "~icons/lucide/arrow-left";
import CheckCircle2 from "~icons/lucide/check-circle-2";
import Circle from "~icons/lucide/circle";
import Clock from "~icons/lucide/clock";
import AlertCircle from "~icons/lucide/alert-circle";
import XCircle from "~icons/lucide/x-circle";

import { dataReader } from "../../lib/data/reader";
import Heading from "../../components/ui/Heading.astro";
import Card from "../../components/ui/Card.astro";
import Button from "../../components/ui/Button.astro";

const { id } = Astro.params;
const { currentUser } = Astro.locals as any;

if (!id || id === "new") {
    return Astro.redirect("/areas");
}

// Use dataReader to get fresh data from filesystem
const project = await dataReader.getProject(id, currentUser);

if (!project) {
    return Astro.redirect("/404");
}

// Get actions for this project
const projectDir = id.replace(/\/project(\.toml)?$/, "");
const projectActions = await dataReader.getProjectActions(
    projectDir,
    currentUser,
);

// Sort actions by status/priority
const statusOrder: Record<string, number> = {
    in_progress: 0,
    todo: 1,
    blocked: 2,
    completed: 3,
    cancelled: 4,
};
const sortedActions = projectActions.sort((a, b) => {
    return (
        (statusOrder[a.data.status] ?? 5) - (statusOrder[b.data.status] ?? 5)
    );
});

const statusIcons: Record<string, any> = {
    todo: Circle,
    in_progress: Clock,
    completed: CheckCircle2,
    blocked: AlertCircle,
    cancelled: XCircle,
};

const statusColors: Record<string, string> = {
    todo: "text-text-muted",
    in_progress: "text-blue-500",
    completed: "text-green-500",
    blocked: "text-red-500",
    cancelled: "text-gray-500",
};

// Get resources (files that are not project.toml or actions)
import { fsApi } from "../../lib/data/api";
import { resolveDataPath } from "../../lib/data/path-resolver";

const projectPath = resolveDataPath(
    path.join("areas", projectDir),
    currentUser,
);
let resources: string[] = [];

try {
    const fullPath = fsApi.resolvePath(projectPath);
    const files = await fs.readdir(fullPath);
    resources = files.filter(
        (file) =>
            file !== "project.toml" &&
            !file.startsWith("act-") &&
            !file.startsWith(".") &&
            !file.endsWith(".DS_Store"),
    );
} catch (e) {
    console.error(
        `Error reading resources for project ${project.data.name}:`,
        e,
    );
}
---

<AppLayout title={`${project.data.name} | Projects`}>
    <div class="max-w-4xl mx-auto space-y-8">
        <div>
            <Button
                href="/areas"
                variant="ghost"
                class="pl-0 hover:pl-2 transition-all"
            >
                <ArrowLeft class="h-4 w-4 mr-2" />
                Back to Areas
            </Button>
        </div>

        <Card class="overflow-hidden">
            <div class="p-4 md:p-8 border-b border-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <span
                            class="px-2.5 py-1 rounded-md text-xs font-medium uppercase tracking-wider bg-primary/10 text-primary"
                        >
                            Project
                        </span>
                        <span
                            class:list={[
                                "px-2.5 py-1 rounded-md text-xs font-medium uppercase tracking-wider",
                                project.data.status === "active"
                                    ? "bg-green-500/10 text-green-500"
                                    : "bg-surface-hover text-text-muted",
                            ]}
                        >
                            {project.data.status}
                        </span>
                    </div>
                    <Button
                        href={`/edit-project?project=${id}`}
                        variant="outline"
                        size="sm"
                    >
                        Edit Project
                    </Button>
                </div>

                <Heading level={1} class="leading-tight mb-2">
                    {project.data.name}
                </Heading>
                {
                    project.data.description && (
                        <p class="text-text-muted text-lg">
                            {project.data.description}
                        </p>
                    )
                }
            </div>

            <div
                class="px-4 md:px-8 py-4 bg-surface-hover/10 flex flex-col md:flex-row gap-2 md:gap-6 text-sm text-text-muted"
            >
                <div>
                    <span class="font-medium text-text-main">Area:</span>
                    {project.data.area}
                </div>
                {
                    project.data.due_date && (
                        <div>
                            <span class="font-medium text-text-main">Due:</span>{" "}
                            {typeof project.data.due_date === "string"
                                ? new Date(
                                      project.data.due_date,
                                  ).toLocaleDateString()
                                : project.data.due_date.toLocaleDateString()}
                        </div>
                    )
                }
            </div>
        </Card>

        <div class="space-y-4">
            <Heading level={2} class="flex items-center gap-2">
                Actions
                <span
                    class="text-sm font-normal text-text-muted bg-surface-hover px-2 py-0.5 rounded-full"
                >
                    {sortedActions.length}
                </span>
            </Heading>

            {
                sortedActions.length > 0 ? (
                    <Card class="overflow-hidden">
                        <div id="actions-list" class="sortable-container">
                            {sortedActions.map((action) => {
                                const Icon =
                                    statusIcons[action.data.status] || Circle;
                                const colorClass =
                                    statusColors[action.data.status] ||
                                    "text-text-muted";

                                // Extract action ID from the full path
                                const actionId =
                                    action.id
                                        .split("/")
                                        .pop()
                                        ?.replace(".md", "") || "";

                                return (
                                    <div
                                        class="action-item p-4 border-b border-border last:border-0 flex items-center gap-4 hover:bg-surface-hover transition-colors group cursor-move"
                                        data-action-id={actionId}
                                        data-path={`areas/${action.id}`}
                                        data-status={action.data.status}
                                    >
                                        <div class="drag-handle p-1 cursor-grab active:cursor-grabbing">
                                            <svg
                                                class="h-4 w-4 text-text-muted"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M4 8h16M4 16h16"
                                                />
                                            </svg>
                                        </div>
                                        <button
                                            class="action-toggle focus:outline-none"
                                            data-path={`areas/${action.id}`}
                                            data-status={action.data.status}
                                            title={
                                                action.data.status ===
                                                "completed"
                                                    ? "Mark as Todo"
                                                    : "Mark as Completed"
                                            }
                                        >
                                            <Icon
                                                class={`h-5 w-5 ${colorClass} hover:scale-110 transition-transform`}
                                            />
                                        </button>
                                        <div class="flex-1 min-w-0">
                                            <span
                                                class={`text-sm font-medium ${action.data.status === "completed" ? "text-text-muted line-through" : "text-text-main"}`}
                                            >
                                                {action.data.title}
                                            </span>
                                        </div>
                                        <span
                                            class:list={[
                                                "text-xs font-medium uppercase tracking-wider px-2 py-0.5 rounded opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity",
                                                action.data.priority === "high"
                                                    ? "bg-red-500/10 text-red-500"
                                                    : "bg-surface-hover text-text-muted",
                                            ]}
                                        >
                                            {action.data.priority}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </Card>
                ) : (
                    <Card class="text-center py-12 border-2 border-dashed border-border bg-surface/50">
                        <p class="text-text-muted">
                            No actions found for this project.
                        </p>
                    </Card>
                )
            }
        </div>

        <script>
            const buttons = document.querySelectorAll(".action-toggle");
            buttons.forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent row click if we add one later

                    const button = e.currentTarget as HTMLButtonElement;
                    const path = button.dataset.path;
                    const currentStatus = button.dataset.status;

                    const newStatus =
                        currentStatus === "completed" ? "todo" : "completed";

                    // Visual feedback
                    button.style.opacity = "0.5";

                    try {
                        const res = await fetch("/api/actions/status", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ path, status: newStatus }),
                        });

                        if (res.ok) {
                            window.location.reload();
                        } else {
                            console.error("Failed to update status");
                            alert("Failed to update status");
                            button.style.opacity = "1";
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error updating status");
                        button.style.opacity = "1";
                    }
                });
            });
        </script>

        <!-- Load SortableJS from CDN -->
        <script
            src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"
        ></script>
        <script>
            // Initialize drag-and-drop for actions
            document.addEventListener("DOMContentLoaded", () => {
                const actionsList = document.getElementById("actions-list");
                if (actionsList) {
                    // Initialize Sortable
                    const sortable = Sortable.create(actionsList, {
                        animation: 150,
                        ghostClass: "sortable-ghost",
                        chosenClass: "sortable-chosen",
                        dragClass: "sortable-drag",
                        handle: ".drag-handle",

                        // Called when item is dropped
                        async onEnd(evt) {
                            const items = Array.from(
                                actionsList.querySelectorAll(".action-item"),
                            );
                            const actionIds = items.map(
                                (item) => item.dataset.actionId,
                            );

                            // Get project directory from URL
                            const pathParts =
                                window.location.pathname.split("/");
                            const projectDir = pathParts.slice(1, -1).join("/"); // Remove /projects/ from start and action ID from end

                            try {
                                const response = await fetch(
                                    "/api/actions/reorder",
                                    {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            actionIds: actionIds,
                                            projectDir: projectDir,
                                        }),
                                    },
                                );

                                if (!response.ok) {
                                    console.error("Failed to reorder actions");
                                    alert("Failed to save new order");
                                    // Refresh to restore original order
                                    window.location.reload();
                                }
                            } catch (error) {
                                console.error(
                                    "Error reordering actions:",
                                    error,
                                );
                                alert("Error saving new order");
                                window.location.reload();
                            }
                        },
                    });
                }
            });
        </script>

        <style>
            .sortable-ghost {
                opacity: 0.4;
                background: var(--color-surface-hover);
            }

            .sortable-chosen {
                background: var(--color-surface);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .sortable-drag {
                transform: rotate(2deg);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }

            .action-item {
                transition: all 0.2s ease;
            }

            .action-item:hover {
                background: var(--color-surface-hover);
            }

            .drag-handle:hover {
                background: var(--color-surface-hover);
                border-radius: 4px;
            }
        </style>

        <div class="space-y-4">
            <Heading level={2} class="flex items-center gap-2">
                Resources
                <span
                    class="text-sm font-normal text-text-muted bg-surface-hover px-2 py-0.5 rounded-full"
                >
                    {resources.length}
                </span>
            </Heading>

            {
                resources.length > 0 ? (
                    <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
                        {resources.map((resource) => (
                            <Card class="p-3 flex items-center gap-3 hover:bg-surface-hover transition-colors">
                                <div class="h-8 w-8 rounded bg-surface-hover flex items-center justify-center text-text-muted">
                                    <span class="uppercase text-xs font-bold">
                                        {resource.split(".").pop()}
                                    </span>
                                </div>
                                <span class="text-sm text-text-main truncate">
                                    {resource}
                                </span>
                            </Card>
                        ))}
                    </div>
                ) : (
                    <p class="text-text-muted text-sm italic">
                        No resources found.
                    </p>
                )
            }
        </div>
    </div>
</AppLayout>
