---
import AppLayout from "../layouts/AppLayout.astro";
import Heading from "../components/ui/Heading.astro";
import SearchForm from "../components/search/SearchForm.astro";

const title = "Search";
const initialQ = Astro.url.searchParams.get("q") || "";
---

<AppLayout title={title} currentPath="/search">
  <div class="space-y-6">
    <Heading level={1}>Search</Heading>

    <!-- Search Form Component -->
    <SearchForm initialQuery={initialQ} />

    <!-- Search Results Component -->
    <div id="results-container" class="space-y-4">
      <div id="results-empty" class="text-center py-12 text-text-muted">
        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p class="text-lg">Start typing to search...</p>
      </div>

      <div id="results-loading" class="hidden text-center py-12">
        <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent"></div>
        <p class="mt-4 text-text-muted">Searching...</p>
      </div>

      <div id="results-list" class="hidden space-y-3"></div>

      <div id="results-none" class="hidden text-center py-12 text-text-muted">
        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <p class="text-lg">No results found</p>
        <p class="text-sm mt-2">Try adjusting your search or filters</p>
      </div>
    </div>
  </div>

  <script>
    let debounceTimer;
    const searchInput = document.getElementById("search-input");
    const filterCollection = document.getElementById("filter-collection");
    const filterStatus = document.getElementById("filter-status");
    const filterPriority = document.getElementById("filter-priority");
    const clearFiltersBtn = document.getElementById("clear-filters");

    const resultsEmpty = document.getElementById("results-empty");
    const resultsLoading = document.getElementById("results-loading");
    const resultsList = document.getElementById("results-list");
    const resultsNone = document.getElementById("results-none");

    function showState(state) {
      resultsEmpty.classList.add("hidden");
      resultsLoading.classList.add("hidden");
      resultsList.classList.add("hidden");
      resultsNone.classList.add("hidden");

      switch (state) {
        case "empty":
          resultsEmpty.classList.remove("hidden");
          break;
        case "loading":
          resultsLoading.classList.remove("hidden");
          break;
        case "results":
          resultsList.classList.remove("hidden");
          break;
        case "none":
          resultsNone.classList.remove("hidden");
          break;
      }
    }

    async function performSearch() {
      const query = searchInput.value.trim();
      const collection = filterCollection.value;
      const status = filterStatus.value;
      const priority = filterPriority.value;

      if (!query && !collection && !status && !priority) {
        showState("empty");
        return;
      }

      showState("loading");

      try {
        const params = new URLSearchParams();
        if (query) params.set("q", query);
        if (collection) params.set("collection", collection);
        if (status) params.set("status", status);
        if (priority) params.set("priority", priority);

        const response = await fetch(`/api/search?${params.toString()}`);
        if (!response.ok) throw new Error("Search failed");

        const results = await response.json();
        displayResults(results);
      } catch (error) {
        console.error("Search error:", error);
        alert("Search failed. Please try again.");
        showState("empty");
      }
    }

    function displayResults(results) {
      if (results.length === 0) {
        showState("none");
        return;
      }

      resultsList.innerHTML = results
        .map((result) => {
          const icon = getCollectionIcon(result.collection);
          const badge = getCollectionBadge(result.collection);
          const statusBadge = result.status
            ? getStatusBadge(result.status)
            : "";
          const priorityBadge = result.priority
            ? getPriorityBadge(result.priority)
            : "";

          return `
                    <a href="${result.url}" class="block group">
                        <div class="p-4 bg-surface border border-border rounded-lg hover:border-primary/50 transition-all duration-200 hover:shadow-md">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    ${icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        ${badge}
                                        ${statusBadge}
                                        ${priorityBadge}
                                    </div>
                                    <h3 class="text-base font-semibold text-text-main group-hover:text-primary transition-colors">
                                        ${escapeHtml(result.title)}
                                    </h3>
                                    ${
                                      result.description
                                        ? `
                                        <p class="text-sm text-text-muted mt-1 line-clamp-2">
                                            ${escapeHtml(result.description)}
                                        </p>
                                    `
                                        : ""
                                    }
                                    ${
                                      result.area
                                        ? `
                                        <p class="text-xs text-text-muted mt-2">
                                            Area: <span class="text-text-main">${escapeHtml(result.area)}</span>
                                        </p>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    </a>
                `;
        })
        .join("");

      showState("results");
    }

    function getCollectionIcon(collection) {
      const iconClass = "h-5 w-5 text-text-muted";
      switch (collection) {
        case "inbox":
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>`;
        case "actions":
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 17 2 2 4-4"></path><path d="m3 7 2 2 4-4"></path><path d="M13 6h8"></path><path d="M13 12h8"></path><path d="M13 18h8"></path></svg>`;
        case "projects":
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><path d="M8 10v4"></path><path d="M12 10v2"></path><path d="M16 10v6"></path></svg>`;
        case "areas":
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></svg>`;
        case "reviews":
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="m9 11 3 3 8-8"></path></svg>`;
        default:
          return `<svg class="${iconClass}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
      }
    }

    function getCollectionBadge(collection) {
      const colors = {
        inbox: "bg-blue-500/10 text-blue-500",
        actions: "bg-green-500/10 text-green-500",
        projects: "bg-purple-500/10 text-purple-500",
        areas: "bg-orange-500/10 text-orange-500",
        reviews: "bg-pink-500/10 text-pink-500",
      };
      const color = colors[collection] || "bg-gray-500/10 text-gray-500";
      return `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${color} capitalize">${collection}</span>`;
    }

    function getStatusBadge(status) {
      const colors = {
        todo: "bg-gray-500/10 text-gray-500",
        in_progress: "bg-blue-500/10 text-blue-500",
        completed: "bg-green-500/10 text-green-500",
        blocked: "bg-red-500/10 text-red-500",
        active: "bg-green-500/10 text-green-500",
        archived: "bg-gray-500/10 text-gray-500",
        on_hold: "bg-yellow-500/10 text-yellow-500",
      };
      const color = colors[status] || "bg-gray-500/10 text-gray-500";
      const label = status.replace("_", " ");
      return `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${color} capitalize">${label}</span>`;
    }

    function getPriorityBadge(priority) {
      const colors = {
        high: "bg-red-500/10 text-red-500",
        medium: "bg-yellow-500/10 text-yellow-500",
        low: "bg-gray-500/10 text-gray-500",
      };
      const color = colors[priority] || "bg-gray-500/10 text-gray-500";
      return `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${color} capitalize">${priority}</span>`;
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    searchInput.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(performSearch, 300);
    });

    filterCollection.addEventListener("change", performSearch);
    filterStatus.addEventListener("change", performSearch);
    filterPriority.addEventListener("change", performSearch);

    clearFiltersBtn.addEventListener("click", () => {
      searchInput.value = "";
      filterCollection.value = "";
      filterStatus.value = "";
      filterPriority.value = "";
      showState("empty");
    });

    // Keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        searchInput.focus();
      }
    });

    // Initialize from URL query
    const params = new URLSearchParams(window.location.search);
    const initialQ = params.get("q") || "";
    if (initialQ) {
      searchInput.value = initialQ;
      performSearch();
    }
  </script>
</AppLayout>