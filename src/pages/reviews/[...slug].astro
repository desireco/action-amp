---
import AppLayout from "../../layouts/AppLayout.astro";
import { getEntry, render } from "astro:content";
import { fsApi } from "../../lib/data/api";
import matter from "gray-matter";
import { marked } from "marked";
import Button from "../../components/ui/Button.astro";
import Card from "../../components/ui/Card.astro";
import ReviewEditor from "../../components/Review/ReviewEditor.astro";
import path from "node:path";

const { currentUser } = Astro.locals as any;
const { slug } = Astro.params;

if (!slug) return Astro.redirect("/reviews");

let entry;
let htmlContent = "";

// We prioritize content collections (isolated by config.ts)
const collectionsEntry = await getEntry("reviews", slug);
if (collectionsEntry) {
    const rendered = await render(collectionsEntry);
    entry = collectionsEntry;
    // Convert the rendered content to HTML for the editor
    htmlContent = await marked.parse(collectionsEntry.body);
} else {
    // Fallback for dynamic content via fsApi (also user-isolated)
    try {
        const filePathPrefix = path.join(
            "reviews",
            slug.endsWith(".md") ? slug : `${slug}.md`,
        );
        const fileContent = await fsApi.readFile(filePathPrefix, currentUser);
        const parsed = matter(fileContent);

        entry = {
            id: slug,
            collection: "reviews",
            data: {
                type: parsed.data.type,
                date: new Date(parsed.data.date),
                ...parsed.data,
            },
            body: parsed.content,
        } as any;

        htmlContent = await marked.parse(parsed.content);
    } catch (e) {
        console.error(`Failed to read review ${slug}:`, e);
        return Astro.redirect("/404");
    }
}

// Read raw content for editing
const filePathPrefix = path.join(
    "reviews",
    slug.endsWith(".md") ? slug : `${slug}.md`,
);
const rawContent = await fsApi.readFile(filePathPrefix, currentUser);
---

<AppLayout title={`${entry?.data?.type || "Review"} Review`}>
    <div class="max-w-3xl mx-auto space-y-6">
        <div class="flex justify-between items-center mb-4">
            <Button
                href="/reviews"
                variant="ghost"
                class="pl-0 hover:pl-2 transition-all"
            >
                ← Back to Reviews
            </Button>
            <div class="flex items-center gap-2">
                <span class="text-sm text-text-muted capitalize">
                    {entry?.data?.type} Review
                </span>
                <span class="text-sm text-text-muted">•</span>
                <span class="text-sm text-text-muted">
                    {entry?.data?.date?.toLocaleDateString()}
                </span>
            </div>
        </div>

        <Card class="p-6">
            <ReviewEditor
                reviewId={slug}
                initialContent={rawContent}
                initialHtml={htmlContent}
                onSave={async (reviewId, content) => {
                    // This will be handled client-side
                    const response = await fetch(`/api/reviews/${reviewId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ content }),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to save review");
                    }

                    // Reload page to show changes
                    window.location.reload();
                }}
            />
        </Card>
    </div>
</AppLayout>

<script>
    // Global keyboard shortcut for editing
    document.addEventListener("keydown", (e) => {
        // Press 'E' to start editing (when not already in an input/textarea)
        if (
            e.key === "e" &&
            !e.metaKey &&
            !e.ctrlKey &&
            !e.shiftKey &&
            document.activeElement?.tagName !== "TEXTAREA" &&
            document.activeElement?.tagName !== "INPUT"
        ) {
            const editButton = document.querySelector(
                'button[title="Edit review (E)"]',
            );
            if (editButton instanceof HTMLButtonElement) {
                editButton.click();
            }
        }
    });
</script>

