---
import AppLayout from "../../layouts/AppLayout.astro";
import { dataReader } from "../../lib/data/reader";
import ArrowRight from "~icons/lucide/arrow-right";
import Trash2 from "~icons/lucide/trash-2";
import FolderInput from "~icons/lucide/folder-input";
import Save from "~icons/lucide/save";
import SkipForward from "~icons/lucide/skip-forward";
import CheckSquare from "~icons/lucide/check-square";
import FileText from "~icons/lucide/file-text";
import Link from "~icons/lucide/link";
import Lightbulb from "~icons/lucide/lightbulb";
import BookOpen from "~icons/lucide/book-open";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/triage");
}

const { currentUser } = Astro.locals as any;

// 1. Fetch all inbox items to determine current item and next item
const inboxItems = await dataReader.getInboxItems(currentUser);

// Sort oldest first
const sortedItems = inboxItems.sort(
    (a, b) =>
        new Date(a.data.captured).getTime() -
        new Date(b.data.captured).getTime(),
);

const currentIndex = sortedItems.findIndex((item) => item.id === id);
const currentItem = sortedItems[currentIndex];

if (!currentItem) {
    return Astro.redirect("/triage");
}

const nextItem = sortedItems[currentIndex + 1];
const nextLink = nextItem ? `/triage/${nextItem.id}` : "/triage";

// 2. Fetch Projects for the "Move" dropdown
const allProjects = await dataReader.getAllProjects(currentUser);
const activeProjects = allProjects.filter((p) => p.data.status === "active");

const typeOptions = [
    { value: "note", label: "Note", icon: FileText },
    { value: "action", label: "Action", icon: CheckSquare },
    { value: "link", label: "Link", icon: Link },
    { value: "idea", label: "Idea", icon: Lightbulb },
    { value: "resource", label: "Resource", icon: BookOpen },
];
---

<AppLayout title="Triage | Action Amp">
    <div class="max-w-6xl mx-auto lg:h-[calc(100vh-8rem)] flex flex-col">
        <!-- Header / Progress -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-text-main">Triage Mode</h1>
                <span
                    class="px-3 py-1 rounded-full bg-surface border border-border text-sm text-text-muted"
                >
                    Item {currentIndex + 1} of {sortedItems.length}
                </span>
            </div>
            <div class="flex items-center gap-2">
                <a
                    href={nextLink}
                    class="flex items-center px-4 py-2 text-sm font-medium text-text-muted hover:text-text-main hover:bg-surface-hover rounded-lg transition-colors"
                >
                    Skip
                    <SkipForward class="ml-2 h-4 w-4" />
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:flex-1 lg:min-h-0">
            <!-- Left Column: Edit -->
            <div class="flex flex-col gap-4 lg:h-full lg:overflow-hidden">
                <div
                    class="bg-surface border border-border rounded-xl p-6 flex-1 flex flex-col lg:overflow-hidden shadow-sm"
                >
                    <form id="edit-form" class="flex-1 flex flex-col gap-4">
                        <div>
                            <label
                                for="title"
                                class="block text-sm font-medium text-text-muted mb-1"
                                >Title</label
                            >
                            <input
                                type="text"
                                name="title"
                                id="title"
                                value={currentItem.data.title}
                                class="w-full bg-background border border-border rounded-lg px-4 py-2 text-lg font-semibold text-text-main focus:outline-none focus:ring-2 focus:ring-primary/50"
                            />
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-text-muted mb-2"
                                >Type</label
                            >
                            <div class="flex flex-wrap gap-2">
                                {
                                    typeOptions.map((option) => (
                                        <label class="cursor-pointer">
                                            <input
                                                type="radio"
                                                name="type"
                                                value={option.value}
                                                checked={
                                                    currentItem.data.type ===
                                                    option.value
                                                }
                                                class="peer sr-only"
                                            />
                                            <div class="px-3 py-2 rounded-lg border border-border bg-background hover:bg-surface-hover peer-checked:bg-primary/10 peer-checked:border-primary peer-checked:text-primary flex items-center gap-2 transition-all">
                                                <option.icon class="h-4 w-4" />
                                                <span class="text-sm font-medium">
                                                    {option.label}
                                                </span>
                                            </div>
                                        </label>
                                    ))
                                }
                            </div>
                        </div>

                        <div class="flex-1 min-h-[200px]">
                            <label
                                for="content"
                                class="block text-sm font-medium text-text-muted mb-1"
                                >Content</label
                            >
                            <textarea
                                name="content"
                                id="content"
                                class="w-full h-full bg-background border border-border rounded-lg px-4 py-3 text-text-main focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none font-mono text-sm"
                                >{currentItem.content}</textarea
                            >
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Process -->
            <div class="flex flex-col gap-6 lg:h-full lg:overflow-y-auto">
                <!-- Action 1: Assign to Project -->
                <div
                    class="bg-surface border border-border rounded-xl p-6 shadow-sm"
                >
                    <h3 class="text-lg font-semibold text-text-main mb-2">
                        Assign to Project
                    </h3>

                    <div class="space-y-4">
                        <select
                            id="project-select"
                            class="w-full bg-background border border-border rounded-lg px-3 py-2 text-text-main focus:outline-none focus:ring-2 focus:ring-primary/50"
                        >
                            <option value="" disabled selected
                                >Select a project...</option
                            >
                            {
                                activeProjects.map((project) => (
                                    <option value={project.id}>
                                        {project.data.name} ({project.data.area}
                                        )
                                    </option>
                                ))
                            }
                        </select>
                        <button
                            id="btn-move"
                            class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white px-4 py-3 rounded-lg font-medium transition-colors shadow-lg shadow-primary/20"
                        >
                            <FolderInput class="h-5 w-5" />
                            Assign & Next
                        </button>
                    </div>
                </div>

                <!-- Action 2: Keep in Inbox -->
                <div
                    class="bg-surface border border-border rounded-xl p-6 shadow-sm"
                >
                    <h3 class="text-lg font-semibold text-text-main mb-2">
                        Keep in Inbox
                    </h3>
                    <p class="text-sm text-text-muted mb-4">
                        Save changes and move to the next item.
                    </p>
                    <button
                        id="btn-save-next"
                        class="w-full flex items-center justify-center gap-2 bg-surface-hover hover:bg-border text-text-main border border-border px-4 py-3 rounded-lg font-medium transition-colors"
                    >
                        <Save class="h-5 w-5" />
                        Save & Next
                    </button>
                </div>

                <!-- Action 3: Delete -->
                <div
                    class="bg-surface border border-border rounded-xl p-6 shadow-sm mt-auto"
                >
                    <h3 class="text-lg font-semibold text-red-500 mb-2">
                        Delete Item
                    </h3>
                    <p class="text-sm text-text-muted mb-4">
                        Permanently remove this item.
                    </p>
                    <button
                        id="delete-button"
                        class="w-full flex items-center justify-center gap-2 bg-red-500/10 hover:bg-red-500/20 text-red-600 border border-red-200 dark:border-red-900/30 px-4 py-3 rounded-lg font-medium transition-colors"
                    >
                        <Trash2 class="h-5 w-5" />
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</AppLayout>

<script define:vars={{ currentId: id, nextLink }}>
    const editForm = document.getElementById("edit-form");
    const btnSaveNext = document.getElementById("btn-save-next");
    const btnMove = document.getElementById("btn-move");
    const btnDelete = document.getElementById("delete-button");
    const projectSelect = document.getElementById("project-select");

    // Helper to get form data
    function getFormData() {
        const formData = new FormData(editForm);
        return {
            title: formData.get("title"),
            type: formData.get("type"),
            content: formData.get("content"),
        };
    }

    // Save & Next
    btnSaveNext?.addEventListener("click", async () => {
        const data = getFormData();
        btnSaveNext.disabled = true;
        btnSaveNext.textContent = "Saving...";

        try {
            const res = await fetch(`/api/inbox/${currentId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            if (res.ok) {
                window.location.href = nextLink;
            } else {
                alert("Failed to save item");
                btnSaveNext.disabled = false;
                btnSaveNext.textContent = "Save & Next";
            }
        } catch (err) {
            console.error(err);
            alert("Error saving item");
            btnSaveNext.disabled = false;
            btnSaveNext.textContent = "Save & Next";
        }
    });

    // Move
    btnMove?.addEventListener("click", async () => {
        const projectId = projectSelect.value;
        if (!projectId) {
            alert("Please select a project first");
            return;
        }

        // First save any edits, then move
        const data = getFormData();
        btnMove.disabled = true;
        btnMove.textContent = "Moving...";

        try {
            // 1. Update content first (optional, but good practice to capture edits)
            await fetch(`/api/inbox/${currentId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            // 2. Move
            const res = await fetch("/api/actions/move", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ inboxItemId: currentId, projectId }),
            });

            if (res.ok) {
                // For move, we always go to /triage to pick up the next available item
                // because the current one is gone, so the list shifts.
                // However, nextLink might point to a specific ID that is now at the current index.
                // Safest is to go to /triage which redirects to the new "first" (oldest) item.
                window.location.href = "/triage";
            } else {
                alert("Failed to move item");
                btnMove.disabled = false;
                btnMove.textContent = "Assign & Next";
            }
        } catch (err) {
            console.error(err);
            alert("Error moving item");
            btnMove.disabled = false;
            btnMove.textContent = "Assign & Next";
        }
    });

    // Delete
    btnDelete?.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this item?")) return;

        btnDelete.disabled = true;
        btnDelete.textContent = "Deleting...";

        try {
            const res = await fetch(`/api/inbox/${currentId}`, {
                method: "DELETE",
            });

            if (res.ok) {
                window.location.href = "/triage";
            } else {
                alert("Failed to delete item");
                btnDelete.disabled = false;
                btnDelete.textContent = "Delete";
            }
        } catch (err) {
            console.error(err);
            alert("Error deleting item");
            btnDelete.disabled = false;
            btnDelete.textContent = "Delete";
        }
    });
</script>
