---
import AppLayout from "../../layouts/AppLayout.astro";
import { CheckCircle2, ArrowRight } from "lucide-astro";
import fs from "node:fs/promises";
import path from "node:path";
import matter from "gray-matter";
import Heading from "../../components/ui/Heading.astro";
import Button from "../../components/ui/Button.astro";

// Read inbox items
const inboxDir = path.join(process.cwd(), "data/inbox");
let inboxItems: any[] = [];

try {
    const files = await fs.readdir(inboxDir);
    const mdFiles = files.filter((f) => f.endsWith(".md"));

    inboxItems = await Promise.all(
        mdFiles.map(async (file) => {
            const content = await fs.readFile(
                path.join(inboxDir, file),
                "utf-8",
            );
            const parsed = matter(content);
            return {
                id: file.replace(".md", ""),
                data: {
                    ...parsed.data,
                    captured: parsed.data.captured
                        ? new Date(parsed.data.captured)
                        : new Date(),
                },
            };
        }),
    );
} catch (e) {
    console.error("Failed to read inbox:", e);
}

// Sort oldest first for triage
const sortedItems = inboxItems.sort(
    (a, b) => a.data.captured.valueOf() - b.data.captured.valueOf(),
);

// If there are items, redirect to the first one
if (sortedItems.length > 0) {
    return Astro.redirect(`/triage/${sortedItems[0].id}`);
}
---

<AppLayout title="Triage | Action Amp">
    <div
        class="flex flex-col items-center justify-center min-h-[60vh] text-center"
    >
        <div
            class="w-24 h-24 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mb-6"
        >
            <CheckCircle2
                class="w-12 h-12 text-green-600 dark:text-green-400"
            />
        </div>
        <Heading level={1} class="mb-2">Inbox Zero!</Heading>
        <p class="text-text-muted text-lg max-w-md mb-8">
            You've processed everything in your inbox. Great job!
        </p>
        <Button href="/inbox" size="lg">
            Go to Inbox
            <ArrowRight class="ml-2 w-5 h-5" />
        </Button>
    </div>
</AppLayout>
