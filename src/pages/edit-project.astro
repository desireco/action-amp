---
import AppLayout from "../layouts/AppLayout.astro";
import { dataReader } from "../lib/data/reader";
import { Loader2 } from "lucide-astro";
import Heading from "../components/ui/Heading.astro";
import Card from "../components/ui/Card.astro";
import Button from "../components/ui/Button.astro";
import Input from "../components/ui/Input.astro";

// Get the project ID from query params
const projectId = Astro.url.searchParams.get("project");

if (!projectId) {
    return Astro.redirect("/projects");
}

const project = await dataReader.getProject(projectId);

if (!project) {
    return Astro.redirect("/404");
}
---

<AppLayout title={`Edit ${project.data.name} | Action Amp`}>
    <div class="max-w-2xl mx-auto">
        <Heading level={1} class="mb-8">Edit Project</Heading>

        <Card class="p-6">
            <form id="edit-project-form" class="space-y-6">
                <input type="hidden" name="projectId" value={projectId} />

                <div>
                    <label
                        for="name"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Project Name</label
                    >
                    <Input
                        type="text"
                        id="name"
                        name="name"
                        required
                        value={project.data.name}
                        placeholder="e.g., Q4 Marketing Campaign"
                    />
                </div>

                <div>
                    <label
                        for="status"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Status</label
                    >
                    <select
                        id="status"
                        name="status"
                        class="flex h-10 w-full rounded-lg border border-border bg-surface px-3 py-2 text-sm text-text-main ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-text-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option
                            value="active"
                            selected={project.data.status === "active"}
                            >Active</option
                        >
                        <option
                            value="on_hold"
                            selected={project.data.status === "on_hold"}
                            >On Hold</option
                        >
                        <option
                            value="completed"
                            selected={project.data.status === "completed"}
                            >Completed</option
                        >
                        <option
                            value="archived"
                            selected={project.data.status === "archived"}
                            >Archived</option
                        >
                    </select>
                </div>

                <div>
                    <label
                        for="priority"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Priority</label
                    >
                    <select
                        id="priority"
                        name="priority"
                        class="flex h-10 w-full rounded-lg border border-border bg-surface px-3 py-2 text-sm text-text-main ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-text-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <option
                            value="high"
                            selected={project.data.priority === "high"}
                            >High</option
                        >
                        <option
                            value="medium"
                            selected={project.data.priority === "medium"}
                            >Medium</option
                        >
                        <option
                            value="low"
                            selected={project.data.priority === "low"}
                            >Low</option
                        >
                    </select>
                </div>

                <div>
                    <label
                        for="description"
                        class="block text-sm font-medium text-text-main mb-1"
                        >Description</label
                    >
                    <textarea
                        id="description"
                        name="description"
                        rows="4"
                        class="w-full bg-background border border-border rounded-lg px-4 py-3 text-text-main placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all resize-none"
                        placeholder="What is this project about?"
                        >{project.data.description || ""}</textarea
                    >
                </div>

                <div class="flex justify-end gap-4">
                    <Button href={`/projects/${projectId}`} variant="ghost">
                        Cancel
                    </Button>
                    <Button
                        type="submit"
                        id="submit-btn"
                        class="flex items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                    >
                        <Loader2
                            class="w-4 h-4 animate-spin hidden"
                            id="submit-spinner"
                        />
                        <span id="submit-text">Save Changes</span>
                    </Button>
                </div>
            </form>
        </Card>
    </div>

    <script>
        const form = document.getElementById("edit-project-form");
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const spinner = document.getElementById("submit-spinner");
        const submitText = document.getElementById("submit-text");

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Show loading state
            submitBtn.disabled = true;
            spinner?.classList.remove("hidden");
            if (submitText) submitText.textContent = "Saving...";

            const formData = new FormData(e.target as HTMLFormElement);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch("/api/projects", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    // Redirect back to the project page
                    window.location.href = `/projects/${data.projectId}`;
                } else {
                    alert("Failed to update project");
                    // Reset loading state on error
                    submitBtn.disabled = false;
                    spinner?.classList.add("hidden");
                    if (submitText) submitText.textContent = "Save Changes";
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred");
                // Reset loading state on error
                submitBtn.disabled = false;
                spinner?.classList.add("hidden");
                if (submitText) submitText.textContent = "Save Changes";
            }
        });
    </script>
</AppLayout>
