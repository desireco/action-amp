---
import Button from "./Button.astro";
import Spinner from "./Spinner.astro";

export interface Props {
  loading?: boolean;
  loadingText?: string;
  children: any;
  variant?: "primary" | "secondary" | "ghost" | "destructive";
  size?: "sm" | "md" | "lg";
  class?: string;
  type?: "button" | "submit" | "reset";
  disabled?: boolean;
  href?: string;
  [key: string]: any;
}

const {
  loading = false,
  loadingText = "Loading...",
  variant = "primary",
  size = "md",
  class: className = "",
  type = "button",
  disabled = false,
  href,
  ...rest
} = Astro.props;

const variants = {
  primary: "bg-primary text-primary-foreground hover:bg-primary/90 shadow",
  secondary:
    "bg-secondary text-secondary-foreground hover:bg-secondary/80 shadow-sm",
  ghost: "hover:bg-accent hover:text-accent-foreground",
  destructive:
    "bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-sm",
  outline:
    "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
  link: "text-primary underline-offset-4 hover:underline",
};

const variantClasses = variants[variant] || variants.primary;
---

{
  href ? (
    <a
      href={href}
      class={`inline-flex items-center justify-center gap-2 px-4 py-2 min-h-[44px] rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed loading-btn ${variantClasses} ${className}`}
      aria-disabled={loading || disabled}
      data-loading-text={loadingText}
    >
      <span class="loading-spinner hidden">
        <Spinner size="sm" />
      </span>
      <span class="loading-text">
        <slot />
      </span>
    </a>
  ) : (
    <button
      type={type}
      class={`inline-flex items-center justify-center gap-2 px-4 py-2 min-h-[44px] rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed loading-btn ${variantClasses} ${className}`}
      disabled={loading || disabled}
      aria-disabled={loading || disabled}
      data-loading-text={loadingText}
      {...rest}
    >
      <span class="loading-spinner hidden">
        <Spinner size="sm" />
      </span>
      <span class="loading-text">
        <slot />
      </span>
    </button>
  )
}

<script>
  // Handle dynamic loading state
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".loading-btn");
    buttons.forEach((btn) => {
      const button = btn as HTMLButtonElement | HTMLAnchorElement;
      const updateState = () => {
        const isLoading = button.hasAttribute("data-loading");
        const spinner = button.querySelector(".loading-spinner");
        const text = button.querySelector(".loading-text");

        if (spinner && text) {
          if (isLoading) {
            spinner.classList.remove("hidden");
            text.textContent =
              button.getAttribute("data-loading-text") || "Loading...";
            if (button instanceof HTMLButtonElement) {
              button.disabled = true;
            } else {
              button.setAttribute("aria-disabled", "true");
              button.classList.add("pointer-events-none");
            }
          } else {
            spinner.classList.add("hidden");
            // Restore original text from a data attribute if available
            const originalText = button.getAttribute("data-original-text");
            if (originalText) {
              text.textContent = originalText;
            }
            if (button instanceof HTMLButtonElement) {
              button.disabled = false;
            } else {
              button.setAttribute("aria-disabled", "false");
              button.classList.remove("pointer-events-none");
            }
          }
        }
      };

      // Store original text
      const text = button.querySelector(".loading-text");
      if (text && !button.hasAttribute("data-original-text")) {
        button.setAttribute("data-original-text", text.textContent || "");
      }

      // Update initially
      updateState();

      // Watch for changes
      const observer = new MutationObserver(updateState);
      observer.observe(button, {
        attributes: true,
        attributeFilter: ["data-loading"],
      });
    });
  });
</script>
